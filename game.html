<!DOCTYPE html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <title>Zeta Primus â€“ JSON RPG</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div class="app">
      <header>
        <div>
          <h1><span class="logo">ğŸš€</span>Zeta Primus</h1>
          <p>
            JSON tabanlÄ± roleplay. Ãœstten senaryoyu seÃ§, karar ver, zar at,
            hikÃ¢yeyi dallandÄ±r.
          </p>
        </div>
        <div
          style="
            display: flex;
            flex-direction: column;
            gap: 4px;
            align-items: flex-end;
          "
        >
          <label style="font-size: 0.7rem; color: var(--muted)">
            Senaryo:
            <select
              id="scenario-select"
              style="font-size: 0.75rem; border-radius: 999px; padding: 3px 8px"
            >
              <option value="helion_kulleri.json">Helion'un KÃ¼lleri</option>
              <option value="echo9_zaman.json">ECHO-9 Zaman Ã‡Ã¶kÃ¼ÅŸÃ¼</option>
              <option value="son_golge_thermopylai.json">
                Son GÃ¶lge: Thermopylai
              </option>
            </select>
          </label>
          <button
            id="load-btn"
            class="btn btn-primary"
            style="font-size: 0.75rem; padding: 4px 10px"
          >
            Senaryoyu YÃ¼kle ve BaÅŸlat
          </button>
          <span class="badge" id="story-status">HenÃ¼z senaryo yÃ¼klenmedi</span>
        </div>
      </header>

      <main>
        <!-- Ãœst panel: Sahne -->
        <section class="panel">
          <div class="panel-header">
            <div>
              <div class="step-counter" id="step-counter">AdÄ±m: -</div>
              <h2>GÃ¶rev Sahnesi</h2>
            </div>
            <div id="step-type" class="badge">Bekliyor</div>
          </div>

          <div class="scene-content">
            <h3 id="step-title">Senaryo seÃ§ ve yÃ¼kle</h3>
            <p id="step-text">
              SaÄŸ Ã¼stten bir JSON senaryo seÃ§ip â€œSenaryoyu YÃ¼kle ve BaÅŸlatâ€
              butonuna bas. Python tarafÄ±nda kullandÄ±ÄŸÄ±n uzun senaryolarÄ± (start
              + nodes yapÄ±sÄ±) burada da okuyabilirsin.
            </p>
          </div>

          <div id="ui-area" class="ui-area"></div>
        </section>

        <!-- Alt panel: GÃ¼nlÃ¼k -->
        <section class="panel">
          <div class="panel-header">
            <h2>GÃ¶rev GÃ¼nlÃ¼ÄŸÃ¼</h2>
          </div>
          <div id="log">
            <p>
              Burada seÃ§imlerin, zar sonuÃ§larÄ±n ve Ã¶nemli olaylar listelenecek.
            </p>
          </div>
        </section>
      </main>

      <footer>
        <span
          >Tipler: narrative Â· choice Â· roll Â· end â†’ hepsi JSONâ€™dan
          geliyor.</span
        >
        <span id="footer-msg"></span>
      </footer>
    </div>

    <script>
      let story = null;
      let nodeMap = {};
      let currentId = null;

      const stepTitleEl = document.getElementById("step-title");
      const stepTextEl = document.getElementById("step-text");
      const stepTypeEl = document.getElementById("step-type");
      const uiAreaEl = document.getElementById("ui-area");
      const logEl = document.getElementById("log");
      const storyStatusEl = document.getElementById("story-status");
      const stepCounterEl = document.getElementById("step-counter");
      const footerMsgEl = document.getElementById("footer-msg");
      const scenarioSelEl = document.getElementById("scenario-select");
      const loadBtn = document.getElementById("load-btn");

      function log(msg) {
        const p = document.createElement("p");
        p.textContent = msg;
        logEl.appendChild(p);
        logEl.scrollTop = logEl.scrollHeight;
      }

      function rollDice(diceSpec) {
        const spec = (diceSpec || "d6").toLowerCase().trim();
        let count, sides;
        if (spec.startsWith("d")) {
          count = 1;
          sides = parseInt(spec.slice(1), 10);
        } else {
          const parts = spec.split("d");
          count = parseInt(parts[0], 10);
          sides = parseInt(parts[1], 10);
        }
        let total = 0;
        for (let i = 0; i < count; i++) {
          total += Math.floor(Math.random() * sides) + 1;
        }
        return total;
      }

      function setStory(data, fileName) {
        story = data;
        nodeMap = {};
        currentId = null;

        if (!story || !Array.isArray(story.nodes)) {
          storyStatusEl.textContent = "HatalÄ± JSON: 'nodes' yok";
          stepTitleEl.textContent = "Senaryo yÃ¼klenemedi";
          stepTextEl.textContent =
            "JSON formatÄ±: { start: 'id', nodes: [ {id, type, ...}, ... ] } olmalÄ±.";
          return;
        }

        story.nodes.forEach((n) => {
          if (n.id) nodeMap[n.id] = n;
        });

        currentId = story.start || (story.nodes[0] && story.nodes[0].id);

        storyStatusEl.textContent = "Senaryo yÃ¼klendi: " + (fileName || "");
        footerMsgEl.textContent = `BaÅŸlangÄ±Ã§: ${currentId} â€¢ Toplam sahne: ${story.nodes.length}`;
        log(
          "â–¶ Senaryo yÃ¼klendi: " +
            (fileName || "") +
            " | BaÅŸlangÄ±Ã§: " +
            currentId
        );

        renderNode();
      }

      function renderNode() {
        uiAreaEl.innerHTML = "";

        if (!currentId || !nodeMap[currentId]) {
          stepTitleEl.textContent = "Senaryo bitti veya geÃ§ersiz id";
          stepTextEl.textContent =
            "FarklÄ± bir rota iÃ§in sayfayÄ± yenileyebilir veya baÅŸka bir JSON seÃ§ebilirsin.";
          stepTypeEl.textContent = "Bitti";
          stepCounterEl.textContent = "AdÄ±m: -";

          const restartBtn = document.createElement("button");
          restartBtn.className = "btn btn-full";
          restartBtn.textContent = "Senaryoyu baÅŸtan baÅŸlat";
          restartBtn.onclick = () => {
            if (!story) return;
            currentId = story.start || (story.nodes[0] && story.nodes[0].id);
            log("â€” Senaryoyu yeniden baÅŸlattÄ±n â€”");
            renderNode();
          };
          uiAreaEl.appendChild(restartBtn);
          return;
        }

        const node = nodeMap[currentId];
        const type = (node.type || "narrative").toLowerCase();

        stepTitleEl.textContent = node.title || currentId;
        stepTextEl.textContent = node.text || "";
        stepCounterEl.textContent = "AdÄ±m: " + currentId;
        stepTypeEl.textContent =
          type === "narrative"
            ? "AnlatÄ±m"
            : type === "choice"
            ? "SeÃ§im"
            : type === "roll"
            ? "Zar"
            : type === "end"
            ? "Final"
            : type.toUpperCase();

        // NARRATIVE
        if (type === "narrative") {
          const btn = document.createElement("button");
          btn.className = "btn btn-primary btn-full";
          btn.textContent = "Devam et";
          btn.onclick = () => {
            log("â€¢ AnlatÄ±m okundu â†’ " + currentId);
            currentId = node.next || null;
            renderNode();
          };
          uiAreaEl.appendChild(btn);
          return;
        }

        // CHOICE
        if (type === "choice") {
          const list = document.createElement("div");
          list.className = "choice-list";

          (node.choices || []).forEach((choice) => {
            const btn = document.createElement("button");
            btn.className = "choice-btn";
            btn.innerHTML = `<strong>${choice.key}</strong><span>${choice.text}</span>`;
            btn.onclick = () => {
              log(`â€¢ SeÃ§im (${currentId}): ${choice.key}) ${choice.text}`);
              uiAreaEl.innerHTML = "";

              const res = document.createElement("p");
              res.style.fontSize = "0.82rem";
              res.style.marginBottom = "8px";
              res.textContent = choice.result_text || "";
              uiAreaEl.appendChild(res);

              const contBtn = document.createElement("button");
              contBtn.className = "btn btn-primary btn-full";
              contBtn.textContent = "Devam et";
              contBtn.onclick = () => {
                currentId = choice.next || node.next || null;
                renderNode();
              };
              uiAreaEl.appendChild(contBtn);
            };
            list.appendChild(btn);
          });

          uiAreaEl.appendChild(list);
          return;
        }

        // ROLL
        if (type === "roll") {
          const diceSpec = node.dice || "d6";
          const target = typeof node.target === "number" ? node.target : 4;

          const info = document.createElement("div");
          info.className = "dice-info";
          info.textContent = `${diceSpec} zarÄ± atÄ±lacak. Hedef â‰¥ ${target}.`;
          uiAreaEl.appendChild(info);

          const resultP = document.createElement("div");
          resultP.className = "dice-result";
          uiAreaEl.appendChild(resultP);

          let rolled = false;
          let nextId = null;

          const rollBtn = document.createElement("button");
          rollBtn.className = "btn btn-primary btn-full";
          rollBtn.innerHTML = "ğŸ² Zar at";
          rollBtn.onclick = () => {
            if (!rolled) {
              // Ä°lk tÄ±k: zar at
              const roll = rollDice(diceSpec);
              const success = roll >= target;
              rolled = true;

              resultP.className =
                "dice-result " + (success ? "success" : "fail");
              resultP.textContent = `Zar sonucu: ${roll} â†’ ${
                success ? "BAÅARI" : "BAÅARISIZLIK"
              }`;

              log(
                `â€¢ Zar (${currentId}/${diceSpec}): ${roll} (${
                  success ? "baÅŸarÄ±lÄ±" : "baÅŸarÄ±sÄ±z"
                })`
              );

              if (node.success_text || node.fail_text) {
                const extra = document.createElement("p");
                extra.style.marginTop = "3px";
                extra.style.fontSize = "0.82rem";
                extra.textContent = success
                  ? node.success_text || ""
                  : node.fail_text || "";
                uiAreaEl.appendChild(extra);
              }

              nextId = success
                ? node.next_success || node.next || null
                : node.next_fail || node.next || null;

              rollBtn.textContent = "Devam et";
            } else {
              // Ä°kinci tÄ±k: sÄ±radaki node'a geÃ§
              currentId = nextId;
              renderNode();
            }
          };
          uiAreaEl.appendChild(rollBtn);
          return;
        }

        // END
        if (type === "end") {
          log("â—† Final: " + (node.ending_key || currentId));

          const msg = document.createElement("p");
          msg.className = "dice-info";
          msg.textContent =
            "Bu bir son. FarklÄ± seÃ§imler ve zarlarla baÅŸka finalleri gÃ¶rebilirsin.";
          uiAreaEl.appendChild(msg);

          const restartBtn = document.createElement("button");
          restartBtn.className = "btn btn-full";
          restartBtn.textContent = "BaÅŸtan oyna";
          restartBtn.onclick = () => {
            currentId = story.start || (story.nodes[0] && story.nodes[0].id);
            log("â€” Oyunu yeniden baÅŸlattÄ±n â€”");
            renderNode();
          };
          uiAreaEl.appendChild(restartBtn);
          return;
        }

        // Bilinmeyen tip
        const unk = document.createElement("p");
        unk.textContent = "Bilinmeyen node tipi: " + type;
        uiAreaEl.appendChild(unk);
      }

      function loadScenarioFromSelect() {
        const file = scenarioSelEl.value;
        if (!file) return;
        storyStatusEl.textContent = "Senaryo yÃ¼kleniyor...";
        log("â€¦ '" + file + "' yÃ¼kleniyor");

        fetch(file)
          .then((r) => {
            if (!r.ok) throw new Error("HTTP " + r.status);
            return r.json();
          })
          .then((data) => setStory(data, file))
          .catch((err) => {
            console.error("Senaryo yÃ¼klenemedi:", err);
            storyStatusEl.textContent = "YÃ¼kleme hatasÄ±";
            stepTitleEl.textContent = "JSON yÃ¼klenemedi";
            stepTextEl.textContent =
              "HTML, JSON dosyalarÄ± ve styles.css aynÄ± klasÃ¶rde olmalÄ±.\n" +
              "EÄŸer dosyayÄ± doÄŸrudan Ã§ift tÄ±klayÄ±p aÃ§Ä±yorsan (file://),\n" +
              "bazÄ± tarayÄ±cÄ±larda fetch() engellenir.\n" +
              "KÃ¼Ã§Ã¼k bir yerel sunucu ile (Ã¶r: python -m http.server) aÃ§man gerekebilir.";
          });
      }

      loadBtn.addEventListener("click", loadScenarioFromSelect);
    </script>
  </body>
</html>
